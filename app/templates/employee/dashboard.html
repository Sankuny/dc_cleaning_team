{% extends "base.html" %}
{% block content %}
<div class="max-w-6xl mx-auto mt-12 px-4">

  <!-- T√≠tulo -->
  <div class="flex justify-between items-center mb-8">
    <h2 class="text-3xl font-bold text-[#003DA5]">{{ t["employee_dashboard"] }}</h2>
    <a href="{{ url_for('employee.assigned_services') }}"
       class="bg-blue-600 text-white px-5 py-2 rounded shadow hover:bg-blue-700 transition text-sm">
      {{ t["view_all_assigned"] }}
    </a>
  </div>

  <!-- üìä Resumen R√°pido -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
    <div class="bg-white p-6 rounded-lg shadow text-center">
      <p class="text-sm text-gray-500">{{ t["services_today"] }}</p>
      <p class="text-2xl font-bold text-blue-700">{{ today_count }}</p>
    </div>
    <div class="bg-white p-6 rounded-lg shadow text-center">
      <p class="text-sm text-gray-500">{{ t["services_week"] }}</p>
      <p class="text-2xl font-bold text-blue-700">{{ week_count }}</p>
    </div>
    <div class="bg-white p-6 rounded-lg shadow text-center">
      <p class="text-sm text-gray-500">{{ t["average_rating"] }}</p>
      <p class="text-2xl font-bold text-yellow-500">{{ average_rating }} ‚≠ê</p>
    </div>
  </div>

  <!-- üßπ Servicios asignados hoy -->
  <h3 class="text-xl font-semibold text-[#003DA5] mb-4">{{ t["assigned_services_today"] }}</h3>
  {% if today_services %}
    <div class="space-y-4">
      {% for s in today_services %}
        <div class="bg-white p-4 rounded-lg shadow border border-blue-100">
          <p><strong>{{ t["service_type"] }}:</strong> {{ t["service_type_labels"][s.service_type] }}</p>
          <p><strong>{{ t["time"] }}:</strong> {{ s.time.strftime('%H:%M') }}</p>
          <p><strong>{{ t["address"] }}:</strong> {{ s.address or "N/A" }}</p>

          {% set others = s.employees | rejectattr("id","equalto",current_user.id) | list %}
          {% if others|length == 0 %}
            <p class="text-xs text-blue-500 mt-1">{{ t["only_you_assigned"] }}</p>
          {% else %}
            <p class="text-xs text-purple-600 mt-1">
              {{ t["shared_with"] }} {{ others|length }}
              {{ others|length == 1 and t["other_singular"] or t["other_plural"] }}
            </p>
          {% endif %}

          <div class="mt-3 text-right" id="service-{{ s.id }}">
            {# Solo si est√° ‚Äúassigned‚Äù mostramos el bot√≥n #}
            {% if s.status == "assigned" %}
              <button data-id="{{ s.id }}"
                      class="complete-btn bg-green-600 text-white px-4 py-1 rounded hover:bg-green-700 text-sm">
                {{ t["mark_completed"] }}
              </button>

            {# Si ya lo marc√≥ el empleado #}
            {% elif s.status == "completed_by_employee" %}
              <p class="text-green-600 mt-2 font-semibold">‚úÖ {{ t["already_completed"] }}</p>

            {# Si el cliente ya confirm√≥ #}
            {% elif s.status == "completed" %}
              <p class="text-blue-600 mt-2 font-semibold">‚≠ê {{ t["client_confirmed"] }}</p>

            {# Cualquier otro estado #}
            {% else %}
              <p class="text-gray-500 mt-2 font-semibold">{{ t["status_labels"][s.status] }}</p>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-gray-500 text-center mb-8">{{ t["no_services_today"] }}</p>
  {% endif %}

  <!-- ‚≠ê √öltimas calificaciones -->
  <h3 class="text-xl font-semibold text-[#003DA5] mt-12 mb-4">{{ t["recent_feedback"] }}</h3>
  {% if ratings %}
    <div class="space-y-4">
      {% for r in ratings %}
        <div class="bg-white p-4 rounded-lg shadow border border-yellow-100">
          <p class="text-yellow-500 text-lg">‚≠ê {{ r.rating }} / 5</p>
          <p class="text-gray-700 text-sm italic mt-1">"{{ r.comment }}"</p>
          <p class="text-xs text-gray-400 mt-1">{{ r.created_at.strftime('%Y-%m-%d') }}</p>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-gray-500 text-center">{{ t["no_feedback_yet"] }}</p>
  {% endif %}

</div>

<!-- ‚úÖ SweetAlert2 CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- ‚úÖ AJAX y toast -->
<script>
  document.querySelectorAll(".complete-btn").forEach(button => {
    button.addEventListener("click", () => {
      const serviceId = button.dataset.id;

      Swal.fire({
        title: "{{ t['swal_title'] }}",
        text: "{{ t['swal_text'] }}",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "{{ t['swal_confirm'] }}",
        cancelButtonText: "{{ t['swal_cancel'] }}"
      }).then(async (result) => {
        if (!result.isConfirmed) return;

        const response = await fetch(`/employee/mark-completed/${serviceId}`, {
          method: "POST",
          headers: {
            "X-Requested-With": "XMLHttpRequest",
            "Content-Type": "application/json"
          }
        });

        if (response.ok) {
          const container = document.getElementById(`service-${serviceId}`);
          container.innerHTML = `<p class="text-green-600 font-semibold mt-2">‚úÖ {{ t["already_completed"] }}</p>`;
          Swal.fire("{{ t['swal_success_title'] }}", "{{ t['swal_success_text'] }}", "success");
        } else if (response.status === 400) {
          Swal.fire("{{ t['swal_error'] }}", "{{ t['swal_wrong_status'] }}", "error");
        } else {
          Swal.fire("Error", "{{ t['swal_error'] }}", "error");
        }
      });
    });
  });
</script>
{% endblock %}

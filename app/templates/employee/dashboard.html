{% extends "base.html" %}
{% block content %}
<div class="max-w-6xl px-4 mx-auto mt-12">

  <!-- T√≠tulo -->
  <div class="flex items-center justify-between mb-8">
    <h2 class="text-3xl font-bold text-primary">{{ t["employee_dashboard"] }}</h2>
    <a href="{{ url_for('employee.assigned_services') }}"
       class="px-5 py-2 text-sm text-white transition rounded shadow bg-primary hover:bg-primaryDark">
      {{ t["view_all_assigned"] }}
    </a>
  </div>

  <!-- üìä Resumen R√°pido -->
  <div class="grid grid-cols-1 gap-6 mb-10 md:grid-cols-3">
    <div class="p-6 text-center bg-white rounded-lg shadow">
      <p class="text-sm text-textSecondary">{{ t["services_today"] }}</p>
      <p class="text-2xl font-bold text-primaryDark">{{ today_count }}</p>
    </div>
    <div class="p-6 text-center bg-white rounded-lg shadow">
      <p class="text-sm text-textSecondary">{{ t["services_week"] }}</p>
      <p class="text-2xl font-bold text-primaryDark">{{ week_count }}</p>
    </div>
    <div class="p-6 text-center bg-white rounded-lg shadow">
      <p class="text-sm text-textSecondary">{{ t["average_rating"] }}</p>
      <p class="text-2xl font-bold text-yellow-500">{{ average_rating }} ‚≠ê</p>
    </div>
  </div>

  <!-- üßπ Servicios asignados hoy -->
  <h3 class="mb-4 text-xl font-semibold text-primary">{{ t["assigned_services_today"] }}</h3>
  {% if today_services %}
    <div class="space-y-4">
      {% for s in today_services %}
        <div class="p-4 bg-white border rounded-lg shadow border-primary/20">
          <p><strong>{{ t["service_type"] }}:</strong> {{ t["service_type_labels"][s.service_type] }}</p>
          <p><strong>{{ t["time"] }}:</strong> {{ s.time.strftime('%H:%M') }}</p>
          <p><strong>{{ t["address"] }}:</strong> {{ s.address or "N/A" }}</p>

          {% set others = s.employees | rejectattr("id","equalto",current_user.id) | list %}
          {% if others|length == 0 %}
            <p class="mt-1 text-xs text-primaryDark">{{ t["only_you_assigned"] }}</p>
          {% else %}
            <p class="mt-1 text-xs text-purple-600">
              {{ t["shared_with"] }} {{ others|length }}
              {{ others|length == 1 and t["other_singular"] or t["other_plural"] }}
            </p>
          {% endif %}

          <div class="mt-3 text-right" id="service-{{ s.id }}">
            {% if s.status == "assigned" %}
              <button data-id="{{ s.id }}"
                      class="px-4 py-1 text-sm text-white bg-green-600 rounded complete-btn hover:bg-green-700">
                {{ t["mark_completed"] }}
              </button>
            {% elif s.status == "completed_by_employee" %}
              <p class="mt-2 font-semibold text-green-600">‚úÖ {{ t["already_completed"] }}</p>
            {% elif s.status == "completed" %}
              <p class="mt-2 font-semibold text-primary">‚≠ê {{ t["client_confirmed"] }}</p>
            {% else %}
              <p class="mt-2 font-semibold text-textSecondary">{{ t["status_labels"][s.status] }}</p>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="mb-8 text-center text-textSecondary">{{ t["no_services_today"] }}</p>
  {% endif %}

  <!-- ‚≠ê √öltimas calificaciones -->
  <h3 class="mt-12 mb-4 text-xl font-semibold text-primary">{{ t["recent_feedback"] }}</h3>
  {% if ratings %}
    <div class="space-y-4">
      {% for r in ratings %}
        <div class="p-4 bg-white border border-yellow-100 rounded-lg shadow">
          <p class="text-lg text-yellow-500">‚≠ê {{ r.rating }} / 5</p>
          <p class="mt-1 text-sm italic text-textMain">"{{ r.comment }}"</p>
          <p class="mt-1 text-xs text-textSecondary">{{ r.created_at.strftime('%Y-%m-%d') }}</p>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-center text-textSecondary">{{ t["no_feedback_yet"] }}</p>
  {% endif %}

</div>

<!-- ‚úÖ SweetAlert2 CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- ‚úÖ AJAX y toast -->
<script>
  document.querySelectorAll(".complete-btn").forEach(button => {
    button.addEventListener("click", () => {
      const serviceId = button.dataset.id;

      Swal.fire({
        title: "{{ t['swal_title'] }}",
        text: "{{ t['swal_text'] }}",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "{{ t['swal_confirm'] }}",
        cancelButtonText: "{{ t['swal_cancel'] }}"
      }).then(async (result) => {
        if (!result.isConfirmed) return;

        const response = await fetch(`/employee/mark-completed/${serviceId}`, {
          method: "POST",
          headers: {
            "X-Requested-With": "XMLHttpRequest",
            "Content-Type": "application/json"
          }
        });

        if (response.ok) {
          const container = document.getElementById(`service-${serviceId}`);
          container.innerHTML = `<p class="mt-2 font-semibold text-green-600">‚úÖ {{ t["already_completed"] }}</p>`;
          Swal.fire("{{ t['swal_success_title'] }}", "{{ t['swal_success_text'] }}", "success");
        } else if (response.status === 400) {
          Swal.fire("{{ t['swal_error'] }}", "{{ t['swal_wrong_status'] }}", "error");
        } else {
          Swal.fire("Error", "{{ t['swal_error'] }}", "error");
        }
      });
    });
  });
</script>
{% endblock %}

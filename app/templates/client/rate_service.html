{% extends "base.html" %}
{% block content %}
<div class="max-w-5xl px-4 mx-auto mt-12">
  <h2 class="mb-10 text-3xl font-bold text-center text-primary">
    {{ t["rate_service_title"] }}
  </h2>

  {% if reservas %}
    <div class="grid grid-cols-1 gap-8">
      {% for r in reservas %}
        <div class="p-6 transition duration-500 ease-in-out transform translate-y-4 bg-white border shadow-lg opacity-0 rounded-xl border-primary/20 hover:shadow-2xl hover:-translate-y-1 animate-target"
             id="card-{{ r.id }}">
          
          <!-- Detalles del servicio -->
          <div class="mb-4">
            <p class="mb-1 text-sm font-semibold uppercase text-primaryDark">{{ t["service_type"] }}</p>
            <p class="text-lg font-medium text-textMain">
              {{ t["service_type_labels"][r.service_type] }}
            </p>
          </div>

          <div class="mb-4">
            <p class="mb-1 text-sm font-semibold uppercase text-primaryDark">{{ t["date"] }}</p>
            <p class="text-lg font-medium text-textMain">{{ r.date.strftime('%Y-%m-%d') }}</p>
          </div>

          <!-- Formulario de calificación -->
          <form class="space-y-4 rating-form" data-id="{{ r.id }}">
            <div>
              <label for="rating" class="block mb-1 font-medium text-textMain">{{ t["rating"] }}</label>
              <select name="rating" class="w-full p-2 border border-gray-300 rounded" required>
                <option value="5">⭐⭐⭐⭐⭐</option>
                <option value="4">⭐⭐⭐⭐</option>
                <option value="3">⭐⭐⭐</option>
                <option value="2">⭐⭐</option>
                <option value="1">⭐</option>
              </select>
            </div>

            <div>
              <textarea name="comment" rows="3" class="w-full p-2 border border-gray-300 rounded resize-none" placeholder="{{ t['comment_placeholder'] }}"></textarea>
            </div>

            <div class="text-right">
              <button type="submit" class="flex items-center gap-2 px-6 py-2 text-white transition duration-300 transform bg-purple-600 rounded hover:bg-purple-700 hover:scale-105">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-white fill-current" viewBox="0 0 20 20">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.185 3.638a1 1 0 00.95.69h3.813c.969 0 1.371 1.24.588 1.81l-3.088 2.244a1 1 0 00-.364 1.118l1.185 3.638c.3.921-.755 1.688-1.54 1.118L10 13.011l-3.088 2.244c-.784.57-1.838-.197-1.539-1.118l1.184-3.638a1 1 0 00-.364-1.118L3.105 9.065c-.783-.57-.38-1.81.588-1.81h3.813a1 1 0 00.95-.69l1.185-3.638z"/>
                </svg>
                {{ t["submit_rating"] }}
              </button>
            </div>
          </form>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="mt-10 text-lg text-center text-textSecondary">
      {{ t["no_services_to_rate"] }}
    </div>
  {% endif %}
</div>

<!-- SweetAlert2 CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- JS: Envío por AJAX -->
<script>
  document.querySelectorAll(".rating-form").forEach(form => {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const reservationId = form.dataset.id;
      const formData = new FormData(form);
      const data = {
        rating: formData.get("rating"),
        comment: formData.get("comment")
      };

      const response = await fetch(`/client/submit-rating/${reservationId}`, {
        method: "POST",
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          "Content-Type": "application/json"
        },
        body: JSON.stringify(data)
      });

      if (response.ok) {
        const card = document.getElementById(`card-${reservationId}`);
        card.innerHTML = `
          <div class="py-10 text-center">
            <p class="text-xl font-semibold text-green-600">⭐ {{ t["thank_you_rating"] }}</p>
          </div>
        `;
        Swal.fire({
          icon: "success",
          title: "⭐ {{ t['swal_thanks'] }}",
          text: "{{ t['swal_success_message'] }}",
          timer: 2500,
          showConfirmButton: false
        });
      } else {
        Swal.fire("Error", "Something went wrong. Please try again.", "error");
      }
    });
  });
</script>

<!-- JS: Animaciones de entrada -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const targets = document.querySelectorAll(".animate-target");
    targets.forEach((el, i) => {
      setTimeout(() => {
        el.classList.remove("opacity-0", "translate-y-4");
        el.classList.add("opacity-100", "translate-y-0");
      }, i * 100);
    });
  });
</script>
{% endblock %}
